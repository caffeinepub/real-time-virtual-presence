{
  "kind": "build_request",
  "title": "Fix camera blocked on Chrome Windows when permission is already granted",
  "projectName": "TogetherFrame",
  "priority": "high",
  "requirements": [
    {
      "id": "REQ-107",
      "text": "In both `frontend/src/components/ar-room/CameraPermissionGate.tsx` and `frontend/src/components/shared-room/CameraPermissionGate.tsx`, diagnose and fix the specific failure mode where Chrome on Windows reports permission state as 'denied' even though the user has granted camera access at the OS/browser level. The fix must: (1) At the very start of the acquisition flow, call `navigator.permissions.query({ name: 'camera' as PermissionName })` and log the returned state to the console for debugging. (2) If the Permissions API itself throws (some Chrome builds have inconsistent PermissionName support), catch that error and fall back to calling `getUserMedia` directly with the tiered constraint approach — do NOT treat a Permissions API failure as a camera denial. (3) Treat a 'denied' state from the Permissions API as a hard block ONLY if `getUserMedia` also throws `NotAllowedError` after exhausting all three constraint tiers (ideal → `{ video: true }` → `{ video: {} }`) with exponential backoff retries (250 ms, 500 ms, 1000 ms per tier). (4) If the Permissions API returns 'denied' but `getUserMedia` succeeds (a known Chrome quirk), accept the stream and proceed — do not block access. (5) Clear `localStorage.removeItem('cameraPermissionGranted')` when the acquisition truly fails after all tiers and retries, so the next load does not silently attempt against a known-bad state. (6) Update the diagnostic panel (collapsible, shown by default on error) to display: the raw Permissions API state, whether the Permissions API query itself threw an error, the browser user-agent, `navigator.mediaDevices` availability, and the last `getUserMedia` error name and message. This is the exact scenario the user reported: Chrome on Windows, `mediaDevices` available, but the component shows 'Camera permission is denied in browser settings' despite the system having granted access.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-1"
        ],
        "quotes": [
          "camera isn't working.",
          "ermission: denied",
          "Browser: Chrome",
          "mediaDevices: available",
          "UA: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko)…",
          "Last Error: Camera permission is denied in browser settings."
        ]
      },
      "acceptanceCriteria": [
        "On Chrome for Windows where the user has already granted camera permission at the browser level, clicking 'Grant Access' (or on silent mount attempt) successfully opens the camera stream without showing 'Camera permission is denied in browser settings'.",
        "If the Permissions API returns 'denied' but getUserMedia with any constraint tier succeeds, the camera stream is accepted and the gate passes through to the camera view.",
        "If the Permissions API query itself throws an error, the component falls back to attempting getUserMedia directly with the tiered constraint approach rather than showing a blocked error.",
        "The diagnostic panel displays the raw Permissions API state, whether the query threw, the browser name, mediaDevices availability, and the last error name and message.",
        "The localStorage 'cameraPermissionGranted' flag is cleared when the acquisition definitively fails after all tiers and retries, preventing a bad silent-attempt on next load.",
        "On a successful getUserMedia call, 'cameraPermissionGranted=true' is written to localStorage.",
        "The 'Try Again' button re-queries the Permissions API fresh (not from cached state) and re-runs the full tiered acquisition sequence.",
        "The fix applies identically to both the AR room and Shared Room variants of CameraPermissionGate.tsx."
      ]
    },
    {
      "id": "REQ-108",
      "text": "In both `frontend/src/components/ar-room/CameraPermissionGate.tsx` and `frontend/src/components/shared-room/CameraPermissionGate.tsx`, update the browser-specific guidance shown in the denied/blocked error UI to include a Chrome-on-Windows specific note that reads: 'If you recently granted camera access but still see this error, click Try Again — Chrome sometimes reports permissions incorrectly. If the problem persists: click the camera/lock icon in the address bar → Site settings → Camera → set to Allow, then click Try Again.' This addresses the confirmed user scenario where Chrome on Windows shows a false denial despite the system having granted camera access.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-1"
        ],
        "quotes": [
          "Browser: Chrome",
          "Last Error: Camera permission is denied in browser settings."
        ]
      },
      "acceptanceCriteria": [
        "When the error UI is displayed on Chrome (detected from user-agent), a specific note is shown explaining that Chrome may incorrectly report denied permissions and instructing the user to click Try Again first before following manual steps.",
        "The Chrome-on-Windows step-by-step instructions correctly reference: lock/camera icon in the address bar → Site settings → Camera → Allow.",
        "The 'Try Again' button is prominently displayed and accessible in the error UI for Chrome users.",
        "The note is shown in both the AR room and Shared Room variants of the denied error UI."
      ]
    }
  ],
  "constraints": [
    "Do not modify any files listed in frontend.immutablePaths.",
    "Do not treat a Permissions API error as a camera denial — if navigator.permissions.query throws, fall back to getUserMedia directly.",
    "Do not block the camera stream if getUserMedia succeeds, regardless of what the Permissions API reports."
  ],
  "nonGoals": [
    "Changes to backend logic.",
    "Changes to any page or component other than the two CameraPermissionGate.tsx files.",
    "Adding new features unrelated to the camera permission denial fix."
  ],
  "imageRequirements": {
    "required": [],
    "edits": []
  }
}